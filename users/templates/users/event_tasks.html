{% extends 'events/base.html' %}
{% load static %}
{% load qr_filters %}
{% block title %}–ó–∞–¥–∞–Ω–∏—è ‚Äî {{ event.title }}{% endblock %}

{% block content %}
<h2>üéØ –ó–∞–¥–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: "{{ event.title }}"</h2>

{% if tasks %}
    {% for task_type, group in tasks|dictsort:"type"|groupby:"type" %}
        <h4 class="mt-4">
            {% if task_type == "system" %}
                ‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
            {% elif task_type == "code" %}
                üì¶ –ë–æ–Ω—É—Å-–∫–æ–¥—ã
            {% else %}
                üîπ –ü—Ä–æ—á–µ–µ
            {% endif %}
        </h4>

        <ul class="list-group mt-2">
            {% for task in group %}
                <li class="list-group-item d-flex justify-content-between align-items-start flex-wrap">
                    <div class="me-auto">
                        <h5>{{ task.name }}</h5>
                        <p class="mb-1">{{ task.description }}</p>
                        <small>üí∞ {{ task.reward }} ‚ÇΩ</small>
                        {% if task.id in completed_ids %}
                            <div class="mt-1 text-success">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                        {% endif %}
                    </div>

                    {% if task.code %}
                        <div class="text-center">
                            <img src="{{ task|generate_task_qr }}" alt="QR-–∫–æ–¥" style="max-width: 150px;" class="mb-2">

                            <div class="input-group mb-2">
                                <input type="text" value="{{ task.code }}" class="form-control" id="code-{{ task.id }}" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ task.id }}')">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            </div>

                            <form method="post" action="{% url 'submit-bonus-code' %}">
                                {% csrf_token %}
                                <input type="hidden" name="code" value="{{ task.code }}">
                                <button type="submit" class="btn btn-sm btn-outline-primary">üì• –í–≤–µ—Å—Ç–∏ –∫–æ–¥</button>
                            </form>
                        </div>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endfor %}
{% else %}
    <p class="text-muted">–î–ª—è —ç—Ç–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π.</p>
{% endif %}

<a href="{% url 'event-detail' event.id %}" class="btn btn-secondary mt-4">‚Üê –ù–∞–∑–∞–¥ –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é</a>
{% endblock %}
{% block extra_scripts %}
<script>
function copyToClipboard(taskId) {
    const input = document.getElementById('code-' + taskId);
    input.select();
    input.setSelectionRange(0, 99999); // –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö

    navigator.clipboard.writeText(input.value).then(function () {
        alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + input.value);
    }, function (err) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏');
    });
}
</script>
{% endblock %}
